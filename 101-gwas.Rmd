---
title: "101-gwas"
output: html_document
date: "2025-08-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(RColorBrewer)
```

Chrom asso, execute in outputs/100

```{sh, eval=FALSE}
bash $HOME/barra-lh/101.1-do-asso.sh $HOME/barra-lh/bamlists/test44.bamlist $HOME/barra-lh/meta/lates-lgs.txt  $HOME/barra-lh/bamlists/test44.pheno

#Adding a few more individuals
bash $HOME/barra-lh/101.1-do-asso.sh $HOME/barra-lh/bamlists/test47.bamlist $HOME/barra-lh/meta/lates-lgs.txt  $HOME/barra-lh/bamlists/test47.pheno
```

There is a peak of association on NC_066856.1
(base) maccamp@farm:~/barra-lh/outputs/101$ gunzip -c *lrt0.gz | sort -n -k 6 | tail  -n 20 | cut -f 1 | sort | uniq -c
      2 NC_066833.1
      3 NC_066835.1
      1 NC_066837.1
      1 NC_066842.1
      1 NC_066844.1
      1 NC_066845.1
      1 NC_066846.1
      1 NC_066850.1
      1 NC_066852.1
      1 NC_066855.1
      7 NC_066856.1

```{r}
d1 <-  read_tsv("outputs/101/NC_066833.1-asso.lrt0.gz")
d3 <- read_tsv("outputs/101/NC_066835.1-asso.lrt0.gz")
d5 <- read_tsv("outputs/101/NC_066837.1-asso.lrt0.gz")
d20 <-read_tsv("outputs/101/NC_066852.1-asso.lrt0.gz")
d24<- read_tsv("outputs/101/NC_066856.1-asso.lrt0.gz")
data<-bind_rows(d1,d3,d5,d20,d24) 

data <- data %>% mutate(log10p = -log10(dchisq(LRT, df = 1))) %>%
  filter(log10p > 2) %>% filter(log10p!="Inf")

data %>% arrange(-log10p) %>% head()
```

With 50% threshold 
NC_066856.1 high score
-log10(dchisq(26.124638,df=1)) -> -log10p of 6.78

We can alter these scores by including three more individuals or four if we allow really low coverage. Why not three the three higher coverage ones?

We can also use the Taiwanese fish as known phenotypes, then maybe need to include PCs. This can boost our catadromous sample sizes.

What about the QLD fish?

```{r}
dd <- data %>% mutate(Index=1:n())

chroms<-dd %>% group_by(Chromosome) %>% mutate(Start=min(Index), Stop=max(Index)) %>% 
  select(Chromosome,Start,Stop) %>% unique() %>% 
  mutate(Position=round((Start+Stop)/2))

outliers <- dd %>% filter(log10p >=10)
#Make enough colors
nb.cols <- nrow(chroms)
mycolors <- colorRampPalette(brewer.pal(8, "Set1"))(nb.cols)


ggplot(dd) +
  geom_point(data=dd, aes(x=Index, y=log10p, color=Chromosome), alpha=0.75, cex=0.5) +
  geom_point(data=outliers, aes(x=Index, y=log10p), color="black", cex=0.5, alpha=0.9) +
  geom_hline(yintercept = 6, lty=2, alpha=0.6) +
  geom_hline(yintercept = 10, lty=2, alpha=0.6) +
  theme_bw() +
  scale_x_continuous(breaks=chroms$Position, labels=chroms$Chromosome) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, face="bold", size=6)) +
  theme(legend.title = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(legend.position = "none") +
  scale_color_manual(values=mycolors) +
  ylab("-log10(p)") +
  xlab("Chromosome") +
  ggtitle("SSS vs SFF GWAS") +
  theme(plot.title = element_text(hjust=0.5) )

ggsave("outputs/101/SSS-SFF-44-inds.jpeg")
```


Find peaks

```{r}
dd %>% filter(log10p > 4)
```